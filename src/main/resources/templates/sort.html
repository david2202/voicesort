<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorator="layout"
      th:with="currentPage='sort'">
<head>
    <style>
        .text-large {
            font-size: 40px;
        }
        .text-medium {
            font-size: 30px;
        }
        .table > tbody > tr:first-child > td {
            border: none;
        }
    </style>
</head>

<body>
<div layout:fragment="content">
    <script th:inline="javascript">
        /*<![CDATA[*/
        // Init the browser's own Speech Recognition
        var recognition = new webkitSpeechRecognition();

        var finalTranscript = '';
        var START_WORD = 'ok';
        var CHOOSE_WORD = 'pick';

        var numberTranslate = {
            "1": 1,
            "one": 1,
            "2": 2,
            "two": 2,
            "to": 2,
            "too": 2,
            "3": 3,
            "three": 3,
            "4": 4,
            "four": 4,
            "for": 4,
            "5": 5,
            "five": 5,
            "6": 6,
            "six": 6,
            "sex": 6,
            "7": 7,
            "seven": 7,
            "8": 8,
            "eight": 8,
            "ate": 8
        };

        initialiseSpeech(recognition);

        var recognizing = false;

        function initialiseSpeech(speech) {
            speech.lang = "en-AU";
            speech.interimResults = false;
            speech.continuous = false;

            speech.onresult = function(event) {
                var final = false;
                var interim_transcript = '';
                for (var i = event.resultIndex; i < event.results.length; ++i) {
                    var result;
                    if (event.results[i].isFinal) {
                        final = true;
                        result = event.results[i][0].transcript;
                        finalTranscript += ' ' + result;
                    } else {
                        result = event.results[i][0].transcript;
                        interim_transcript += ' ' + result;
                    }
                }
                if (final) {
                    doRecognise(finalTranscript.toLowerCase());
                }
            };

            speech.onstart = function() {
                recognizing = true;
                $("#light").attr("src", "/images/greenLight.png");
            };

            speech.onend = function() {
                recognizing = false;
                $("#light").attr("src", "/images/redLight.png");
                speech.start();
            };

            speech.start();
        }

        function doRecognise(text) {
            var nbrResults = $("#results > tbody > tr").length;
            while (text.toLowerCase().includes(START_WORD)) {
                text = text.slice(text.toLowerCase().indexOf(START_WORD) + START_WORD.length).trim();
                finalTranscript = text;
                $('#results > tbody').empty();
                $("#text").val(text);
            }
            if (text.toLowerCase().includes(CHOOSE_WORD) && nbrResults > 0) {
                 text = text.slice(text.toLowerCase().indexOf(CHOOSE_WORD)).trim();
                var row;
                if (nbrResults == 1) {
                    row = 0;
                } else {
                    row = numberTranslate[text.split(" ")[1]] - 1;
                }
                $("#results > tbody > tr").removeClass('success');
                $("#results > tbody > tr:eq(" + row + ")").addClass('success');
                finalTranscript = '';
            } else {
                if (text.trim().length > 0) {
                    $('#results > tbody').empty();
                    doSearch(text, $("#postCode").val());
                } else {
                    $('#results > tbody').empty();
                }
            }
            $("#text").val(text);
        }

        function doSearch(text, postCode) {
            $.get("/rest/api/speech",
                {text:  text, postCode: postCode},
                function(data) {
                    var html = '';
                    for (var i = 0; i < data.length; i++) {
                        html += '<tr><td class="inverse">' + (i+1) + '</td><td>' + data[i].address + '</td><td>' + data[i].roundId + '</td></tr>';
                    }
                    $('#results > tbody:last-child').append(html);
                }
            );
        }
        /*]]>*/
    </script>
    <div class="row">
        <div class="col-xs-2">
            <select id="postCode" class="form-control">
                <option value="3103">3103</option>
                <option value="3124">3124</option>
                <option value="3127">3127</option>
            </select>
        </div>
        <div class="col-xs-2">
            <select id="productType" class="form-control">
                <option value="LL">Large Letters</option>
                <option value="SP">Small Parcels</option>
            </select>
        </div>
        <div class="col-xs-6">
            <input id="text" class="form-control text-medium"/>
        </div>
        <div class="col-xs-2">
            <button type="button" id="submit" class="btn">Submit</button>
            <img id="light" th:src="@{/images/redLight.png}" src="../static/images/redLight.png" />
        </div>
    </div>
    <div class="row">
        <div class="col-xs-12">
            <div class="table-responsive">
                <table id="results" class="table table-striped table-condensed text-large">
                    <tbody id="body">
                        <tr><td class="inverse">1</td><td>19 amelia st mckinnon 3204</td><td>RND_1234</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script th:inline="javascript">
    /*<![CDATA[*/
    $("#submit").click(function () {
        doRecognise($("#text").val());
    })
    /*]]>*/
    </script>
</div>
</body>
</html>