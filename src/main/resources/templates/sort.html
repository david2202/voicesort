<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorator="layout"
      th:with="currentPage='sort'">
<head>
    <script src="//cdnjs.cloudflare.com/ajax/libs/SpeechKITT/0.3.0/speechkitt.min.js"></script>
</head>

<body>
<div layout:fragment="content">
    <script th:inline="javascript">
        /*<![CDATA[*/
        // Init the browser's own Speech Recognition
        var recognition = new webkitSpeechRecognition();

        var final_transcript = '';
        var START_WORD = 'ok';

        initialiseSpeech(recognition);

        var recognizing = false;

        function initialiseSpeech(speech) {
            speech.lang = "en-AU";
            speech.interimResults = true;
            speech.continuous = true;

            speech.onresult = function(event) {
                var final = false;
                var interim_transcript = '';
                for (var i = event.resultIndex; i < event.results.length; ++i) {
                    var result;
                    if (event.results[i].isFinal) {
                        final = true;
                        if (event.results[i][0].transcript.includes(START_WORD)) {
                            final_transcript = '';
                            result = event.results[i][0].transcript.slice(event.results[i][0].transcript.indexOf(START_WORD) + START_WORD.length);
                        } else {
                            result = event.results[i][0].transcript;
                        }
                        final_transcript += ' ' + result;
                    } else {
                        if (event.results[i][0].transcript.includes(START_WORD)) {
                            final_transcript = '';
                            result = event.results[i][0].transcript.slice(event.results[i][0].transcript.indexOf(START_WORD) + START_WORD.length);
                        } else {
                            result = event.results[i][0].transcript;
                        }
                        interim_transcript += ' ' + result;
                    }
                }
                if (final) {
                    console.log(final_transcript);
                    $.get("/rest/api/speech",
                        { text:  final_transcript},
                        function(data) {
                            $('#results > tbody').empty();
                            var html = '';
                            for (var i = 0; i < data.length; i++) {
                                html += '<tr><td>' + data[i].address + '</td><td>' + data[i].roundId + '</td></tr>';
                            }
                            $('#results > tbody:last-child').append(html);
                        }
                    );
                }
            };

            speech.onstart = function() {
                recognizing = true;
            };

            speech.onend = function() {
                recognizing = false;
                speech.start();
            };

            speech.start();
        }
        /*]]>*/
    </script>
    <div class="table-responsive">
        <table id="results" class="table">
            <tbody id="body">
                <tr><td>19 amelia st mckinnon 3204</td><td>RND_1234</td></tr>
            </tbody>
        </table>
    </div>
</div>
</body>
</html>